name: Update Homebrew

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    name: Update Homebrew Cask
    runs-on: macos-latest
    steps:
      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download DMG and calculate SHA256
        id: sha256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.event.release.tag_name }}" \
            --repo "${{ github.repository }}" \
            --pattern "Claudius_${{ steps.version.outputs.version }}_aarch64.dmg" \
            --dir /tmp

          SHA256=$(shasum -a 256 "/tmp/Claudius_${{ steps.version.outputs.version }}_aarch64.dmg" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://oauth2:${HOMEBREW_TAP_TOKEN}@github.com/chrisvanbuskirk/homebrew-claudius.git" /tmp/homebrew-claudius
          cd /tmp/homebrew-claudius

          cat > Casks/claudius.rb << 'CASKEOF'
          cask "claudius" do
            version "${{ steps.version.outputs.version }}"
            sha256 "${{ steps.sha256.outputs.sha256 }}"

            url "https://github.com/chrisvanbuskirk/claudius/releases/download/v#{version}/Claudius_#{version}_aarch64.dmg"
            name "Claudius"
            desc "Local AI research briefing agent powered by Claude"
            homepage "https://github.com/chrisvanbuskirk/claudius"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Claudius.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/Claudius.app"],
                             sudo: false
            end

            zap trash: [
              "~/.claudius",
              "~/Library/Preferences/com.claudius.app.plist",
              "~/Library/Caches/com.claudius.app",
              "~/Library/Application Support/com.claudius.app",
            ]
          end
          CASKEOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/claudius.rb
          git commit -m "Update claudius to ${{ steps.version.outputs.version }}"
          git push
